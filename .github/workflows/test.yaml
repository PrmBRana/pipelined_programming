name: test
on: [push, workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-24.04

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2Ô∏è‚É£ Install Icarus Verilog
      - name: Install iverilog
        shell: bash
        run: sudo apt-get update && sudo apt-get install -y iverilog

      # 3Ô∏è‚É£ Setup Python
      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4Ô∏è‚É£ Install Python dependencies including cocotbext-uart
      - name: Install Python packages
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r test/requirements.txt
          python -m pip install cocotb==1.9.2 cocotbext-uart

      # 5Ô∏è‚É£ Verify cocotbext installation
      - name: Verify cocotbext
        shell: bash
        run: |
          python - <<'EOF'
          import cocotb
          import cocotbext.uart
          print("cocotbext-uart OK")
          EOF

      # 6Ô∏è‚É£ Cache PDK
      - name: Cache PDK
        uses: actions/cache@v4
        with:
          path: ~/.volare
          key: volare-${{ runner.os }}-sky130

      # 7Ô∏è‚É£ Install LibreLane
      - name: Install LibreLane
        shell: bash
        run: pip install librelane

      # 8Ô∏è‚É£ Run cocotb tests
      - name: Run tests
        shell: bash
        run: |
          cd test
          make clean
          make
          # Fail CI if results.xml contains failures
          if grep -q failure results.xml; then
            echo "Tests failed"
            exit 1
          fi

      # 9Ô∏è‚É£ Test summary
      - name: Test Summary
        uses: test-summary/action@v2.3
        with:
          paths: "test/results.xml"
        if: always()

      # üîü Upload waveform and test results
      - name: Upload waveform and test results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test/tb.fst
            test/results.xml
            test/output/*